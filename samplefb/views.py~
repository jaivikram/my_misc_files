from django.http import HttpResponse, HttpResponseRedirect
from django.shortcuts import render_to_response
import facebook
KEY = "cae798a3eeee7948f1c497cda0584597"
SECRET = "eed6d123b1a500b74dc832e8e4cea681"
import logging
logging.basicConfig(level = logging.DEBUG)
log = logging.getLogger('fb')
import urllib
import simplejson
URL = "http://boffter.com:9999/"

def getFBO(request):
    fb = facebook.Facebook(api_key=KEY, secret_key=SECRET)
    fb.session_key = request.session['session_key']
    fb.uid = request.session['uid']
    return fb

def sendme(request):
    #fb = facebook.Facebook(api_key=KEY, secret_key=SECRET)
    #auth_token = fb.auth.createToken()
    #request.session['auth_token'] = auth_token
    return HttpResponseRedirect("http://www.facebook.com/login.php?return_session=true&fbconnect=true&next=%sfb/return/&v=1.0&api_key=%s&display=page" % (URL, KEY))

def returnme(request):
    """
    session=
        %7B
        %22session_key%22%3A%223.EGk0k1NBu1iadhxB_ghC4g__.3600.1264165200-100000671225404%22%2C%22
        uid%22%3A100000671225404%2C%22
        expires%22%3A1264165200%2C%22
        secret%22%3A%2225cJhs1qcIunITj8oqX7Aw__%22%2C%22
        sig%22%3A%226537658b3e9cd53ce68cd89dc067171b%22
        %7D
    """
    response = simplejson.loads(urllib.unquote(request.GET['session']))
    request.session['session_key'] = response['session_key']
    request.session['uid'] = response['uid']
    fb = getFBO(request)
    log.info(str(response))
    try:
        userinfo  = fb.users.getInfo([fb.uid], ['name', 'birthday'])
        log.info(str(userinfo))
    except:
        log.exception('')
    stream_perm_url = fb.get_ext_perm_url('read_stream', next='%sfb/offlineaccess/' % URL)
    return HttpResponseRedirect(stream_perm_url)

def offlineaccess(request):
    fb = getFBO(request)
    offline_access_url = fb.get_ext_perm_url('offline_access', next='%sfb/show/' % URL)
    return HttpResponseRedirect(offline_access_url)
    
def show(request):
    """
    {u'albums': {}, u'posts': [{u'filter_key': u'', u'likes': {u'count': 0, u'can_like': True, u'sample': {}, u'href': u'http://www.facebook.com/social_graph.php?node_id=265462813539&class=LikeManager', u'friends': {}, u'user_likes': False}, u'permalink': u'http://www.facebook.com/profile.php?v=feed&story_fbid=265462813539&id=100000671225404', u'attribution': None, u'tagged_ids': None, u'privacy': {u'description': u'Everyone', u'value': u'EVERYONE'}, u'action_links': None, u'target_id': None, u'app_id': None, u'comments': {u'count': 0, u'comment_list': {}, u'can_remove': True, u'can_post': True}, u'viewer_id': 100000671225404L, u'post_id': u'100000671225404_265462813539', u'app_data': {}, u'actor_id': 100000671225404L, u'created_time': 1264162495, u'source_id': 100000671225404L, u'message': u'test post 2', u'updated_time': 1264162495, u'type': 46, u'is_hidden': False, u'attachment': {u'description': u''}}, {u'filter_key': u'', u'likes': {u'count': 0, u'can_like': True, u'sample': {}, u'href': u'http://www.facebook.com/social_graph.php?node_id=440681920633&class=LikeManager', u'friends': {}, u'user_likes': False}, u'permalink': u'http://www.facebook.com/profile.php?v=feed&story_fbid=440681920633&id=100000671225404', u'attribution': None, u'tagged_ids': None, u'privacy': {u'description': u'Everyone', u'value': u'EVERYONE'}, u'action_links': None, u'target_id': None, u'app_id': None, u'comments': {u'count': 1, u'comment_list': [{u'fromid': 100000671225404L, u'text': u'test comment', u'id': u'100000671225404_440681920633_11018404', u'time': 1264162666}], u'can_remove': True, u'can_post': True}, u'viewer_id': 100000671225404L, u'post_id': u'100000671225404_440681920633', u'app_data': {}, u'actor_id': 100000671225404L, u'created_time': 1264162491, u'source_id': 100000671225404L, u'message': u'test post 1', u'updated_time': 1264162666, u'type': 46, u'is_hidden': False, u'attachment': {u'description': u''}}], u'profiles': [{u'url': u'http://www.facebook.com/profile.php?id=100000671225404', u'pic_square': u'http://static.ak.fbcdn.net/pics/q_silhouette.gif', u'type': u'user', u'id': 100000671225404L, u'name': u'Testchrome Os'}]}
    """
    try:
        fb = getFBO(request)
        log.info(str(fb.stream.get(viewer_id=fb.uid)))
    except:
        log.exception('')
    return HttpResponse('done')
